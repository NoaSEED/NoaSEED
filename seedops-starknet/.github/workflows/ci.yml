name: SEED Ops Starknet CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar validaciones diarias a las 2:00 UTC
    - cron: '0 2 * * *'

env:
  STARKNET_USER: starknet
  STARKNET_HOME: /opt/starknet

jobs:
  validate-scripts:
    name: Validate Bash Scripts
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup shellcheck
      uses: reviewdog/action-shellcheck@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        reporter: github-pr-review
        
    - name: Validate script syntax
      run: |
        echo "ðŸ” Validando sintaxis de scripts bash..."
        
        # Verificar que todos los scripts sean ejecutables
        chmod +x scripts/*.sh
        
        # Validar sintaxis de cada script
        for script in scripts/*.sh; do
          echo "Validando: $script"
          bash -n "$script"
          if [ $? -eq 0 ]; then
            echo "âœ… $script: Sintaxis vÃ¡lida"
          else
            echo "âŒ $script: Error de sintaxis"
            exit 1
          fi
        done
        
        echo "âœ… Todos los scripts tienen sintaxis vÃ¡lida"
        
    - name: Validate script security
      run: |
        echo "ðŸ”’ Validando seguridad de scripts..."
        
        # Verificar que los scripts usen set -euo pipefail
        for script in scripts/*.sh; do
          if ! grep -q "set -euo pipefail" "$script"; then
            echo "âŒ $script: No usa set -euo pipefail"
            exit 1
          fi
          echo "âœ… $script: ConfiguraciÃ³n de seguridad vÃ¡lida"
        done
        
        echo "âœ… Todos los scripts cumplen estÃ¡ndares de seguridad"
        
    - name: Validate script headers
      run: |
        echo "ðŸ“‹ Validando headers de scripts..."
        
        # Verificar que todos los scripts tengan headers apropiados
        for script in scripts/*.sh; do
          if ! grep -q "SEED Ops" "$script"; then
            echo "âŒ $script: Header de SEED Ops no encontrado"
            exit 1
          fi
          if ! grep -q "Institutional Node Operations Handbook" "$script"; then
            echo "âŒ $script: Referencia a INOH no encontrada"
            exit 1
          fi
          echo "âœ… $script: Header vÃ¡lido"
        done
        
        echo "âœ… Todos los scripts tienen headers vÃ¡lidos"

  validate-configs:
    name: Validate Configurations
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Docker Compose
      run: |
        echo "ðŸ³ Validando Docker Compose..."
        
        # Verificar sintaxis del archivo docker-compose
        if [ -f "compose/starknet.docker-compose.yml" ]; then
          docker-compose -f compose/starknet.docker-compose.yml config
          echo "âœ… Docker Compose vÃ¡lido"
        else
          echo "âŒ Archivo docker-compose no encontrado"
          exit 1
        fi
        
    - name: Validate environment template
      run: |
        echo "ðŸ”§ Validando template de variables de entorno..."
        
        # Verificar que el archivo de ejemplo existe
        if [ ! -f "env/starknet.env.example" ]; then
          echo "âŒ Archivo de variables de entorno de ejemplo no encontrado"
          exit 1
        fi
        
        # Verificar que no contenga claves reales
        if grep -q "YOUR_API_KEY_HERE\|your_ethereum_api_key_here" "env/starknet.env.example"; then
          echo "âœ… Archivo de ejemplo no contiene claves reales"
        else
          echo "âŒ Archivo de ejemplo puede contener claves reales"
          exit 1
        fi
        
        echo "âœ… Template de variables de entorno vÃ¡lido"
        
    - name: Validate configuration template
      run: |
        echo "âš™ï¸  Validando template de configuraciÃ³n..."
        
        # Verificar que el archivo de configuraciÃ³n existe
        if [ ! -f "templates/config.yaml.j2" ]; then
          echo "âŒ Template de configuraciÃ³n no encontrado"
          exit 1
        fi
        
        # Verificar que use variables de entorno
        if grep -q "\${.*}" "templates/config.yaml.j2"; then
          echo "âœ… Template usa variables de entorno"
        else
          echo "âŒ Template no usa variables de entorno"
          exit 1
        fi
        
        echo "âœ… Template de configuraciÃ³n vÃ¡lido"

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate markdown files
      run: |
        echo "ðŸ“š Validando archivos markdown..."
        
        # Verificar que los archivos markdown existan
        required_docs=("README.md" "INOH/starknet-infra.md" "playbooks/starknet.md")
        
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "âŒ Documento requerido no encontrado: $doc"
            exit 1
          fi
          echo "âœ… $doc: Encontrado"
        done
        
        echo "âœ… Todos los documentos requeridos estÃ¡n presentes"
        
    - name: Validate documentation links
      run: |
        echo "ðŸ”— Validando enlaces en documentaciÃ³n..."
        
        # Verificar enlaces internos
        if grep -q "\[.*\]\(.*\)" README.md; then
          echo "âœ… README contiene enlaces"
        else
          echo "âŒ README no contiene enlaces"
          exit 1
        fi
        
        echo "âœ… Enlaces en documentaciÃ³n vÃ¡lidos"

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate directory structure
      run: |
        echo "ðŸ“ Validando estructura del repositorio..."
        
        # Verificar directorios requeridos
        required_dirs=("INOH" "playbooks" "scripts" "compose" "templates" "env" ".github/workflows")
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ Directorio requerido no encontrado: $dir"
            exit 1
          fi
          echo "âœ… $dir: Encontrado"
        done
        
        echo "âœ… Estructura del repositorio vÃ¡lida"
        
    - name: Validate file permissions
      run: |
        echo "ðŸ” Validando permisos de archivos..."
        
        # Verificar que los scripts sean ejecutables
        for script in scripts/*.sh; do
          if [ -x "$script" ]; then
            echo "âœ… $script: Ejecutable"
          else
            echo "âŒ $script: No es ejecutable"
            exit 1
          fi
        done
        
        echo "âœ… Permisos de archivos vÃ¡lidos"

  validate-makefile:
    name: Validate Makefile
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Makefile syntax
      run: |
        echo "ðŸ”§ Validando Makefile..."
        
        # Verificar que el Makefile existe
        if [ ! -f "Makefile" ]; then
          echo "âŒ Makefile no encontrado"
          exit 1
        fi
        
        # Verificar sintaxis bÃ¡sica del Makefile
        if make -n help > /dev/null 2>&1; then
          echo "âœ… Makefile tiene sintaxis vÃ¡lida"
        else
          echo "âŒ Makefile tiene errores de sintaxis"
          exit 1
        fi
        
    - name: Validate Makefile targets
      run: |
        echo "ðŸŽ¯ Validando targets del Makefile..."
        
        # Verificar targets requeridos
        required_targets=("bootstrap" "harden" "deploy" "monitor" "backup" "incident" "all")
        
        for target in "${required_targets[@]}"; do
          if make -n "$target" > /dev/null 2>&1; then
            echo "âœ… Target '$target': VÃ¡lido"
          else
            echo "âŒ Target '$target': InvÃ¡lido o no implementado"
            exit 1
          fi
        done
        
        echo "âœ… Todos los targets requeridos estÃ¡n implementados"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Test Docker Compose
      run: |
        echo "ðŸ§ª Probando Docker Compose..."
        
        # Crear directorio temporal para testing
        mkdir -p /tmp/test-starknet
        
        # Copiar archivos necesarios
        cp -r compose /tmp/test-starknet/
        cp -r templates /tmp/test-starknet/
        cp env/starknet.env.example /tmp/test-starknet/env/starknet.env
        
        # Crear directorios necesarios
        mkdir -p /tmp/test-starknet/opt/starknet/{data,keys,logs,config}
        
        # Probar configuraciÃ³n del docker-compose
        cd /tmp/test-starknet
        docker-compose -f compose/starknet.docker-compose.yml config
        
        echo "âœ… Docker Compose vÃ¡lido para testing"
        
    - name: Test script execution
      run: |
        echo "ðŸ§ª Probando ejecuciÃ³n de scripts..."
        
        # Probar que los scripts se pueden parsear
        for script in scripts/*.sh; do
          echo "Probando: $script"
          bash -n "$script"
          echo "âœ… $script: Parseable"
        done
        
        echo "âœ… Todos los scripts son ejecutables"

  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check INOH compliance
      run: |
        echo "ðŸ“‹ Verificando cumplimiento INOH..."
        
        # Verificar que la documentaciÃ³n institucional estÃ© presente
        if [ -f "INOH/starknet-infra.md" ]; then
          echo "âœ… DocumentaciÃ³n institucional presente"
          
          # Verificar contenido mÃ­nimo
          if grep -q "Requerimientos de hardware" "INOH/starknet-infra.md"; then
            echo "âœ… Requerimientos de hardware documentados"
          else
            echo "âŒ Requerimientos de hardware no documentados"
            exit 1
          fi
          
          if grep -q "EstÃ¡ndares de seguridad" "INOH/starknet-infra.md"; then
            echo "âœ… EstÃ¡ndares de seguridad documentados"
          else
            echo "âŒ EstÃ¡ndares de seguridad no documentados"
            exit 1
          fi
          
        else
          echo "âŒ DocumentaciÃ³n institucional no encontrada"
          exit 1
        fi
        
        echo "âœ… Cumplimiento INOH verificado"
        
    - name: Check security standards
      run: |
        echo "ðŸ”’ Verificando estÃ¡ndares de seguridad..."
        
        # Verificar que no haya secretos en el cÃ³digo
        if grep -r "password\|secret\|key\|token" --include="*.sh" --include="*.yml" --include="*.yaml" scripts/ compose/ templates/ | grep -v "example\|template\|placeholder"; then
          echo "âŒ Posibles secretos encontrados en el cÃ³digo"
          exit 1
        else
          echo "âœ… No se encontraron secretos en el cÃ³digo"
        fi
        
        # Verificar que los scripts usen prÃ¡cticas seguras
        secure_practices=("set -euo pipefail" "chmod 600" "chown starknet:starknet")
        
        for practice in "${secure_practices[@]}"; do
          if grep -r "$practice" scripts/ > /dev/null; then
            echo "âœ… PrÃ¡ctica de seguridad encontrada: $practice"
          else
            echo "âš ï¸  PrÃ¡ctica de seguridad no encontrada: $practice"
          fi
        done
        
        echo "âœ… EstÃ¡ndares de seguridad verificados"

  final-report:
    name: Generate Final Report
    runs-on: ubuntu-latest
    needs: [validate-scripts, validate-configs, validate-docs, validate-structure, validate-makefile, security-scan, integration-test, compliance-check]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate validation report
      run: |
        echo "ðŸ“Š Generando reporte de validaciÃ³n..."
        
        # Crear reporte
        cat > validation-report.md << EOF
        # SEED Ops Starknet - Reporte de ValidaciÃ³n CI
        
        ## Resumen de EjecuciÃ³n
        - **Fecha:** $(date -u)
        - **Commit:** ${{ github.sha }}
        - **Branch:** ${{ github.ref_name }}
        
        ## Estado de Jobs
        
        EOF
        
        # Agregar estado de cada job
        for job in validate-scripts validate-configs validate-docs validate-structure validate-makefile security-scan integration-test compliance-check; do
          if [ "${{ needs.$job.result }}" == "success" ]; then
            echo "- âœ… **$job:** Exitoso" >> validation-report.md
          elif [ "${{ needs.$job.result }}" == "failure" ]; then
            echo "- âŒ **$job:** FallÃ³" >> validation-report.md
          else
            echo "- âš ï¸  **$job:** ${{ needs.$job.result }}" >> validation-report.md
          fi
        done
        
        echo "" >> validation-report.md
        echo "## Recomendaciones" >> validation-report.md
        echo "" >> validation-report.md
        
        # Agregar recomendaciones basadas en resultados
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "- ðŸ”’ **Seguridad:** No se encontraron vulnerabilidades crÃ­ticas" >> validation-report.md
        else
          echo "- âš ï¸  **Seguridad:** Revisar resultados del escaneo de seguridad" >> validation-report.md
        fi
        
        if [ "${{ needs.compliance-check.result }}" == "success" ]; then
          echo "- ðŸ“‹ **Compliance:** Cumple estÃ¡ndares INOH" >> validation-report.md
        else
          echo "- âš ï¸  **Compliance:** Revisar cumplimiento de estÃ¡ndares INOH" >> validation-report.md
        fi
        
        echo "" >> validation-report.md
        echo "---" >> validation-report.md
        echo "*Reporte generado automÃ¡ticamente por GitHub Actions*" >> validation-report.md
        
        echo "âœ… Reporte de validaciÃ³n generado"
        
    - name: Upload validation report
      uses: actions/upload-artifact@v3
      with:
        name: validation-report
        path: validation-report.md
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('validation-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
